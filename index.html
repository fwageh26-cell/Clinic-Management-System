<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>MediFlow - نظام العيادة المتصل</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 md:p-8" onload="loadPatients()">
    <h1 class="text-3xl font-bold text-center mb-8 text-blue-600">نظام إدارة العيادة (قاعدة بيانات حية)</h1>
    
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md mb-10">
        <h3 class="font-bold mb-4 text-gray-700">تسجيل مريض جديد</h3>
        <input id="patientName" type="text" placeholder="اسم المريض" class="w-full p-2 border rounded mb-3">
        <button onclick="addPatient()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">حفظ في قاعدة البيانات</button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-green-50 p-4 rounded-lg shadow">
            <h2 class="font-bold text-green-700 mb-4 border-b border-green-200 pb-2 text-center">قائمة الانتظار</h2>
            <div id="waitingList" class="space-y-3"></div>
        </div>
        <div class="bg-yellow-50 p-4 rounded-lg shadow">
            <h2 class="font-bold text-yellow-700 mb-4 border-b border-yellow-200 pb-2 text-center">مع الطبيب</h2>
            <div id="doctorList" class="space-y-3"></div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg shadow">
            <h2 class="font-bold text-gray-700 mb-4 border-b border-gray-200 pb-2 text-center">انتهى</h2>
            <div id="finishedList" class="space-y-3"></div>
        </div>
    </div>

    <script>
        // وظيفة لجلب البيانات من MongoDB فور فتح الموقع
        async function loadPatients() {
            try {
                const res = await fetch('/api/patients');
                const data = await res.json();
                document.getElementById('waitingList').innerHTML = ""; // تنظيف القائمة
                data.forEach(p => displayPatient(p));
            } catch (err) { console.error("خطأ في التحميل:", err); }
        }

        async function addPatient() {
            const nameInput = document.getElementById('patientName');
            const name = nameInput.value;
            if (!name) return alert("يرجى كتابة الاسم");

            const newPatient = { 
                name: name, 
                status: 'waiting', 
                time: new Date().toLocaleTimeString('ar-EG') 
            };

            // إرسال البيانات للجسر (API) ليضعها في MongoDB
            const res = await fetch('/api/patients', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newPatient)
            });

            if (res.ok) {
                displayPatient(newPatient);
                nameInput.value = "";
            } else {
                alert("فشل الحفظ في قاعدة البيانات. تأكد من إعدادات MongoDB");
            }
        }

        function displayPatient(p) {
            const card = document.createElement('div');
            card.className = "bg-white p-3 rounded shadow-sm border-r-4 border-green-500";
            card.innerHTML = `
                <p class="font-bold text-gray-800">${p.name}</p>
                <p class="text-xs text-gray-400">وقت الدخول: ${p.time}</p>
            `;
            document.getElementById('waitingList').appendChild(card);
        }
    </script>
</body>
</html>
